# **Spots SMS認証仕様書（Codex向け）**

## 1. 概要
Spotsは「地図×SNS×イベント共有」プラットフォーム。  
投稿の健全性を保つため、**投稿時のみSMS本人認証を要求**する「二層アカウント構造」を採用する。  
認証済みユーザはバッジ表示で信頼性を可視化。

---

## 2. フロー概要
1. 新規登録：メール or Google連携 → ログイン・閲覧可能。  
2. 投稿操作：「投稿する」ボタン押下時にSMS認証要求。  
3. SMSコード入力画面：6桁コードを入力。  
4. 成功時：Firestore `users.phoneVerified = true` を付与。  
5. 認証済み後は再認証不要（番号変更・通報累積時のみ再要求）。  
6. プロフィール・投稿カードに「✅認証済み」バッジ表示。

---

## 3. UX要件
| 項目 | 内容 |
|------|------|
| 認証トリガ | 投稿送信前。認証済なら通過、未認証ならモーダル起動。 |
| 離脱防止 | 投稿フォーム完了後にSMSを挟む（開始時は出さない）。 |
| メッセージ | 「本人確認のためSMSコードをお送りします📱」など柔らかい文言。 |
| 再送制限 | 3回まで。60秒クールダウン。 |
| エラーメッセージ | 「桁数が足りません（現在9桁／必要10–11桁）」など即時表示。 |
| アクセシビリティ | 色に依存せず、アイコン＋テキストで伝達。 |

---

## 4. バリデーション仕様
- **入力整形**：`libphonenumber`使用（例：090→+8190形式）。  
- **国推定**：デフォルト`JP(+81)`、他国も選択可。  
- **番号形式**：E.164フォーマット。  
- **禁止値**：連続数字（0000000000など）・不正桁数はエラー。  
- **貼り付け対応**：スペース・記号削除、全角→半角変換。  
- **回線種別判定**（任意）：Twilio Lookupで携帯回線のみ許可。  
- **不正防止**：同番号の短期間多重試行やIPスパムを検出。  

---

## 5. セキュリティ方針
| 項目 | 実装方針 |
|------|-----------|
| データ保存 | 電話番号は非可逆ハッシュ化。生データは保持しない。 |
| 認証結果 | Firestore: `users.phoneVerified = true` のみ保存。 |
| 多重登録防止 | Firebase Authで同番号重複登録を自動拒否。 |
| スパム防止 | 同一IPの大量SMS送信をFirebase RateLimitで遮断。 |
| 監査 | `verifiedAt` を記録、更新ログを残す。 |

---

## 6. コスト最適化
| 項目 | 対策 |
|------|------|
| 送信件数削減 | 投稿時のみ送信（ログイン時不要）。 |
| 無料枠利用 | Firebase Auth 無料枠（10,000通/月）を活用。 |
| 再送制限 | 3回／1分間隔ブロック。 |
| 再認証頻度 | 1回認証で永続有効（番号変更時のみ再実施）。 |
| ミス削減 | リアルタイム整形で再送回避。 |

---

## 7. 実装ガイドライン（Codex向け）
- **バックエンド**  
  - 投稿APIに `phoneVerified` チェック追加。  
  - 未認証時：HTTP 412 (`PHONE_VERIFICATION_REQUIRED`)。  
  - 認証成功はFirebase Phone Auth→Cloud Functions経由で`users`更新。  

- **フロントエンド**  
  - 投稿ボタン押下時に `phoneVerified` 判定。  
  - 未認証→SMS認証モーダル（送信→コード入力→確認→完了）。  
  - 成功時にプロフィールへ即時反映。  
  - 再送ボタンは60秒タイマー制御。  

---

## 8. Firestore設計
```json
users: {
  uid: "string",
  phoneVerified: true,
  verifiedAt: "timestamp",
  phoneHash: "sha256(...)",
  trust_score: 70
}
```

セキュリティルール：
```js
allow update: if request.auth.uid == resource.id
  && !(request.resource.data.phoneVerified == true && resource.data.phoneVerified != true);
```

---

## 9. テストケース
| ケース | 条件 | 期待結果 |
|--------|------|----------|
| 初回投稿 | 未認証ユーザ | SMSモーダル表示→認証成功後投稿可 |
| 再投稿 | 認証済ユーザ | そのまま投稿成功 |
| コード誤入力 | 誤り3回 | 再送待機・再入力可 |
| 再送制限 | 連続クリック | 60秒制限発動 |
| SMS未達 | 通信遮断 | エラーメッセージ＋代替導線 |
| テスト番号 | Firebase登録済番号 | 自動成功 |

---

## 10. 信頼スコア連携（拡張）
認証済みユーザは内部スコア `trust_score` +20。  
通報・BAN履歴に応じて減算し、投稿制限判定に利用。
